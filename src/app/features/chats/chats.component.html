<div class="layout" (click)="closeAll()">

  <!-- ğŸŒŒ BACKGROUND -->
  <div class="bg"></div>
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>

  <!-- LEFT SIDEBAR -->
  <aside
    class="sidebar"
    [class.mobileHide]="!mobileListOpen"
    (click)="$event.stopPropagation()"
  >
    <!-- TOP -->
    <div class="top">
      <div class="logoRow">
        <div class="logo">
          <span class="logoDot"></span>
          <span class="logoText">Chatloop</span>
        </div>

        <div class="tag">Premium</div>
      </div>

      <div class="searchWrap">
        <span class="sIcon">ğŸ”</span>
        <input
          class="search"
          [(ngModel)]="searchText"
          (input)="applyFilter()"
          placeholder="Search chats or people..."
          (click)="$event.stopPropagation()"
        />
      </div>
    </div>

    <!-- LIST -->
    <div class="list">

      <div class="section-title">Chats</div>

      <div
        *ngFor="let r of filteredRooms"
        class="item"
        [class.active]="selectedRoomId === r.id"
        (click)="openRoom(r)"
      >
        <div class="avatar" [ngStyle]="getAvatarStyleForRoom(r)">

          <img
            *ngIf="usersMap.get(getOtherUid(r))?.photoURL"
            [src]="usersMap.get(getOtherUid(r))?.photoURL"
            class="avatarImg"
          />

          <span *ngIf="!usersMap.get(getOtherUid(r))?.photoURL">
            {{ (getRoomTitle(r)[0] || 'U').toUpperCase() }}
          </span>

        </div>

        <div class="info">
          <div class="row">
            <div class="name">{{ getRoomTitle(r) }}</div>
            <div class="time">{{ formatTime(r.updatedAt) }}</div>
          </div>

          <div class="row2">
            <div class="preview">{{ getPreviewText(r) }}</div>

            <div class="right">
              <span *ngIf="isPinned(r)" class="icon">ğŸ“Œ</span>
              <span *ngIf="isMuted(r)" class="icon">ğŸ”•</span>

              <div *ngIf="getUnread(r) > 0" class="badge">
                {{ getUnread(r) }}
              </div>
            </div>
          </div>
        </div>

        <button class="more" (click)="$event.stopPropagation(); openMenu($event, r)">â‹®</button>
      </div>

      <div *ngIf="filteredRooms.length === 0" class="emptyLeft">No chats found</div>

      <!-- âœ… PEOPLE SECTION -->
      <ng-container *ngIf="shouldShowPeople()">

        <div class="divider"></div>

        <div class="section-title">People</div>

        <div class="people-list">
          <div class="chat-item" *ngFor="let u of filteredUsers">

           <div class="avatar small" [ngStyle]="getAvatarStyleForUser(u)">

            <img
              *ngIf="u.photoURL"
              [src]="u.photoURL"
              class="avatarImgSmall"
            />

            <span *ngIf="!u.photoURL">
              {{ (u.name || u.email || '?').slice(0,1).toUpperCase() }}
            </span>

          </div>


            <div class="meta" (click)="startDmWithUser(u)">
              <div class="title">{{ u.name || u.email || 'Unknown' }}</div>
              <div class="sub">{{ u.email || u.phone || '' }}</div>
            </div>

            <button class="pillBtn" (click)="$event.stopPropagation(); startDmWithUser(u)">
              Start
            </button>

          </div>

          <div *ngIf="filteredUsers.length === 0" class="emptyLeft">No users found</div>
        </div>
      </ng-container>

    </div>
  </aside>

  <!-- RIGHT CONTENT -->
  <main class="content">

    <!-- âœ… Telegram Mobile Header -->
    <div class="mobileHeader" *ngIf="showMobileChatHeader()">
      <button class="backBtn" (click)="backToList()">â†</button>
      <div class="mobileTitle">{{ getMobileChatTitle() }}</div>
    </div>

    <ng-container *ngIf="selectedUser">
      <div class="chatWrap">
        <app-chat [user]="selectedUser"></app-chat>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedRoomId && !selectedUser">
      <div class="chatWrap">
        <app-chat-room [roomId]="selectedRoomId"></app-chat-room>
      </div>
    </ng-container>

    <ng-container *ngIf="!selectedUser && !selectedRoomId">
      <div class="empty">
        <div class="iconBig">ğŸ’¬</div>
        <div class="t1">Select a chat</div>
        <div class="t2">Choose from the left panel</div>
      </div>
    </ng-container>

  </main>

  <!-- âœ… FIXED MENU -->
  <div
    class="dropdown fixedMenu"
    *ngIf="menuRoomId"
    [ngStyle]="{ top: menuPos.y + 'px', left: menuPos.x + 'px' }"
    (click)="$event.stopPropagation()"
  >
    <button (click)="toggleMute(getMenuItem())">
      {{ isMuted(getMenuItem()) ? 'ğŸ”” Unmute' : 'ğŸ”• Mute' }}
    </button>

    <button (click)="togglePin(getMenuItem())">
      {{ isPinned(getMenuItem()) ? 'ğŸ“Œ Unpin' : 'ğŸ“Œ Pin' }}
    </button>

    <div class="menuDivider"></div>

    <button class="danger" (click)="deleteChatForMe(getMenuItem())">
      ğŸ—‘ Delete chat
    </button>

    <button
      class="danger2"
      *ngIf="canDeleteRoom(getMenuItem())"
      (click)="deleteChatForever(getMenuItem())"
    >
      âŒ Delete forever
    </button>
  </div>

</div>
