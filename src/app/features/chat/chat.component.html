<div class="chat-view" *ngIf="user" (click)="closeAllMenus()">

  <!-- HEADER -->
  <header class="header" (click)="$event.stopPropagation()">
    <div class="left" (click)="openProfileDrawer()">
      <div class="avatar">{{ (user.name || 'U')[0] }}</div>

      <div class="info">
        <div class="title">{{ user.name || 'User' }}</div>
        <div class="sub">
          {{ user.phone || user.email || 'No info' }}
          <span *ngIf="isBlocked" class="pill danger">Blocked</span>
        </div>
      </div>
    </div>

    <button class="iconBtn" (click)="toggleHeaderMenu($event)">â‹®</button>

    <div class="dropdown" *ngIf="showHeaderMenu" (click)="$event.stopPropagation()">
      <button (click)="toggleMute()">
        {{ isMuted ? 'ğŸ”” Unmute' : 'ğŸ”• Mute' }}
      </button>
      <button (click)="togglePin()">
        {{ isPinned ? 'ğŸ“Œ Unpin' : 'ğŸ“Œ Pin' }}
      </button>
      <button class="danger" (click)="toggleBlock()">
        {{ isBlocked ? 'âœ… Unblock' : 'â›” Block' }}
      </button>
    </div>
  </header>

  <!-- MESSAGES -->
  <div class="messages" #messagesBox>
    <div
      *ngFor="let m of messages"
      class="bubble"
      [class.me]="m.senderId === myUid"
      [class.deleted]="m.isDeleted"
      (click)="openMsgMenu($event, m)"
    >
      <div class="text">

        <!-- âœ… IMAGE -->
        <ng-container *ngIf="m.type === 'image' && m.fileUrl && !m.isDeleted">
          <img class="imgMsg" [src]="m.fileUrl" />
          <div class="caption" *ngIf="m.text">{{ m.text }}</div>
        </ng-container>

        <!-- âœ… FILE -->
        <ng-container *ngIf="m.type === 'file' && m.fileUrl && !m.isDeleted">
          <a class="fileMsg" [href]="m.fileUrl" target="_blank" rel="noopener">
            <div class="fileIcon2">ğŸ“</div>
            <div class="fileMeta">
              <div class="fileName2">{{ m.fileName || 'File' }}</div>
              <div class="fileSize2">
                {{ (m.fileSize || 0) > 0 ? ((m.fileSize || 0) / 1024 / 1024).toFixed(1) + ' MB' : '' }}
              </div>
            </div>
          </a>
        </ng-container>

        <!-- âœ… TEXT -->
        <ng-container *ngIf="(!m.type || m.type === 'text' || m.type === 'link') && !m.isDeleted">
          {{ m.text }}
        </ng-container>

        <!-- âœ… DELETED -->
        <ng-container *ngIf="m.isDeleted">
          <span class="deletedText">This message was deleted</span>
        </ng-container>

      </div>

      <div class="meta" *ngIf="!m.isDeleted">
        <span *ngIf="m.editedAt">edited</span>
      </div>
    </div>
  </div>

  <!-- MESSAGE MENU -->
  <div
    class="msgMenu"
    *ngIf="menuMessageId"
    [style.left.px]="menuX"
    [style.top.px]="menuY"
    (click)="$event.stopPropagation()"
  >
    <button (click)="clickEdit()">âœï¸ Edit</button>
    <button class="danger" (click)="clickDelete()">ğŸ—‘ Delete</button>
  </div>

  <!-- EDIT BAR -->
  <div class="editBar" *ngIf="editingId" (click)="$event.stopPropagation()">
    <div class="editTitle">Editing message</div>

    <div class="editRow">
      <input [(ngModel)]="editingText" placeholder="Edit message..." />
      <button (click)="saveEdit()">Save</button>
      <button class="ghost" (click)="cancelEdit()">Cancel</button>
    </div>
  </div>

  <!-- âœ… COMPOSER -->
  <div class="composer" (click)="$event.stopPropagation()">

    <!-- attach -->
    <button
      class="attachBtn"
      [class.disabled]="sendingFile || isBlocked"
      (click)="toggleAttachMenu($event)"
      [disabled]="sendingFile || isBlocked"
      type="button"
    >
      ğŸ“
    </button>

    <!-- attach menu -->
    <div class="attachMenu" *ngIf="showAttachMenu" (click)="$event.stopPropagation()">
      <button (click)="chooseAttachType('image')">ğŸ–¼ Image</button>
      <button (click)="chooseAttachType('document')">ğŸ“„ Document</button>
    </div>

    <!-- hidden input -->
    <input #fileInput type="file" hidden (change)="pickFile($event)" />

    <input
      [(ngModel)]="text"
      placeholder="Message..."
      [disabled]="isBlocked || sendingFile"
      (keydown.enter)="send()"
    />

    <button (click)="send()" [disabled]="isBlocked || (!text.trim() && !selectedFile) || sendingFile">
      {{ sendingFile ? 'Uploading...' : 'Send' }}
    </button>
  </div>

  <!-- âœ… preview -->
  <div class="filePreview" *ngIf="selectedFile">
    <div class="fileInfo">
      <div class="fileName">ğŸ“ {{ selectedFile.name }}</div>
      <div class="fileSize">{{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB</div>
    </div>
    <button class="removeFile" type="button" (click)="clearSelectedFile()">âœ–</button>
  </div>

  <div class="uploadErr" *ngIf="fileError">{{ fileError }}</div>

  <div class="blockedInfo" *ngIf="isBlocked">
    You blocked this user. Unblock to send messages.
  </div>

  <!-- âœ… PROFILE DRAWER -->
  <div class="drawerBackdrop" *ngIf="showUserProfile" (click)="closeProfileDrawer()">
    <div class="drawer" (click)="$event.stopPropagation()">
      <div class="dHero">
        <button class="dClose" (click)="closeProfileDrawer()">âœ–</button>

        <div class="dAvatar">{{ (user.name || 'U')[0] }}</div>
        <div class="dName">{{ user.name || 'User' }}</div>
        <div class="dStatus">
          {{ user.phone || user.email || 'No info' }}
        </div>

        <div class="dActions">
          <button class="act" (click)="callUser()">ğŸ“</button>
          <button class="act" (click)="videoCallUser()">ğŸ¥</button>
          <button class="act" (click)="searchInChat()">ğŸ”</button>
          <button class="act" (click)="copyText(user.uid)">ğŸ“‹</button>
        </div>
      </div>

      <div class="drawerBody">
        <div class="card">
          <div class="row">
            <span>Phone</span>
            <b>{{ user.phone || '-' }}</b>
          </div>
          <div class="row">
            <span>Bio</span>
            <b>{{ user.bio || 'No bio' }}</b>
          </div>
          <div class="row">
            <span>User ID</span>
            <b class="mono">{{ user.uid }}</b>
          </div>

          <div class="btnRow">
            <button class="btn ghost" (click)="copyText(profileLink)">ğŸ”— Copy link</button>
            <button class="btn ghost" (click)="copyText(user.uid)">ğŸ“‹ Copy UID</button>
          </div>

          <div class="btnRow">
            <button class="btn primary" (click)="addToContacts()" [disabled]="isContact">
              {{ isContact ? 'âœ… Added' : 'â• Add Contact' }}
            </button>
            <button class="btn danger" (click)="toggleBlock()">
              {{ isBlocked ? 'âœ… Unblock' : 'â›” Block' }}
            </button>
          </div>
        </div>

        <div class="tabs">
          <button (click)="setTab('media')" [class.active]="profileTab==='media'">Media</button>
          <button (click)="setTab('files')" [class.active]="profileTab==='files'">Files</button>
          <button (click)="setTab('links')" [class.active]="profileTab==='links'">Links</button>
        </div>

        <div class="tabContent" *ngIf="profileTab==='media'">
          <div *ngIf="sharedMedia.length === 0" class="emptyTab">No media shared yet.</div>
          <div class="mediaGrid" *ngIf="sharedMedia.length > 0">
            <img *ngFor="let img of sharedMedia" [src]="img" class="mediaImg" />
          </div>
        </div>

        <div class="tabContent" *ngIf="profileTab==='files'">
          <div *ngIf="sharedFiles.length === 0" class="emptyTab">No files shared yet.</div>

          <a class="fileRow" *ngFor="let f of sharedFiles" [href]="f.url" target="_blank">
            <div class="fileIcon">ğŸ“„</div>
            <div class="fileInfo">
              <div class="fileName">{{ f.name }}</div>
              <div class="fileSize">{{ f.size }}</div>
            </div>
          </a>
        </div>

        <div class="tabContent" *ngIf="profileTab==='links'">
          <div *ngIf="sharedLinks.length === 0" class="emptyTab">No links shared yet.</div>
          <a class="link" *ngFor="let l of sharedLinks" [href]="l.url" target="_blank">
            ğŸ”— {{ l.url }}
          </a>
        </div>

        <div class="card qrCard" *ngIf="qrDataUrl">
          <div>
            <div class="qrTitle">ğŸ“· QR Code</div>
            <div class="qrSub">Scan to open Chatloop profile</div>
            <div class="mono small">{{ profileLink }}</div>
          </div>
          <img class="qr" [src]="qrDataUrl" />
        </div>
      </div>
    </div>
  </div>
</div>
