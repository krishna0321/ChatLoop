<div
  class="chat-view"
  *ngIf="user"
  [class.kbOpen]="keyboardOpen"
  (click)="closeAllMenus()"
>

  <!-- ================= HEADER ================= -->
  <header class="header" (click)="$event.stopPropagation()">
    <div class="left" (click)="openProfileDrawer()">
      <div class="avatar">{{ (user.name || 'U')[0] }}</div>

      <div class="info">
        <div class="title">{{ user.name || 'User' }}</div>
        <div class="sub">
          {{ user.phone || user.email || 'No info' }}
          <span *ngIf="isBlocked" class="pill danger">Blocked</span>
        </div>
      </div>
    </div>

    <button class="iconBtn" (click)="toggleHeaderMenu($event)">â‹®</button>

    <div class="dropdown" *ngIf="showHeaderMenu" (click)="$event.stopPropagation()">
      <button (click)="toggleMute()">
        {{ isMuted ? 'ğŸ”” Unmute' : 'ğŸ”• Mute' }}
      </button>
      <button (click)="togglePin()">
        {{ isPinned ? 'ğŸ“Œ Unpin' : 'ğŸ“Œ Pin' }}
      </button>
      <button class="danger" (click)="toggleBlock()">
        {{ isBlocked ? 'âœ… Unblock' : 'â›” Block' }}
      </button>
    </div>
  </header>

  <!-- ================= MESSAGES ================= -->
  <div class="messages" #messagesBox>
    <div
      *ngFor="let m of messages"
      class="bubble"
      [class.me]="m.senderId === myUid"
      [class.deleted]="m.isDeleted"
      (click)="openMsgMenu($event, m)"
    >
      <div class="text">

        <!-- IMAGE -->
        <ng-container *ngIf="m.type === 'image' && m.fileUrl && !m.isDeleted">
          <img class="imgMsg" [src]="m.fileUrl" />
          <div class="caption" *ngIf="m.text">{{ m.text }}</div>
        </ng-container>

        <!-- FILE -->
        <ng-container *ngIf="m.type === 'file' && m.fileUrl && !m.isDeleted">
          <a class="fileMsg" [href]="m.fileUrl" target="_blank" rel="noopener">
            <div class="fileIcon2">ğŸ“</div>
            <div class="fileMeta">
              <div class="fileName2">{{ m.fileName || 'File' }}</div>
              <div class="fileSize2">
                {{
                  (m.fileSize || 0) > 0
                    ? ((m.fileSize || 0) / 1024 / 1024).toFixed(1) + ' MB'
                    : ''
                }}
              </div>
            </div>
          </a>
        </ng-container>

        <!-- TEXT -->
        <ng-container
          *ngIf="(!m.type || m.type === 'text' || m.type === 'link') && !m.isDeleted"
        >
          {{ m.text }}
        </ng-container>

        <!-- DELETED -->
        <ng-container *ngIf="m.isDeleted">
          <span class="deletedText">This message was deleted</span>
        </ng-container>
      </div>

      <!-- âœ… META (TIME + EDITED) -->
      <div class="meta" *ngIf="!m.isDeleted">
        <span class="time">{{ formatTime(m.createdAt) }}</span>
        <span *ngIf="m.editedAt"> Â· edited</span>
      </div>
    </div>
  </div>

  <!-- ================= MESSAGE MENU ================= -->
  <div
    class="msgMenu"
    *ngIf="menuMessageId"
    [style.left.px]="menuX"
    [style.top.px]="menuY"
    (click)="$event.stopPropagation()"
  >
    <button (click)="clickEdit()">âœï¸ Edit</button>
    <button class="danger" (click)="clickDelete()">ğŸ—‘ Delete</button>
  </div>

  <!-- ================= EDIT BAR ================= -->
  <div class="editBar" *ngIf="editingId" (click)="$event.stopPropagation()">
    <div class="editTitle">Editing message</div>

    <div class="editRow">
      <input [(ngModel)]="editingText" placeholder="Edit message..." />
      <button (click)="saveEdit()">Save</button>
      <button class="ghost" (click)="cancelEdit()">Cancel</button>
    </div>
  </div>

  <!-- ================= FILE PREVIEW ================= -->
  <div class="filePreview" *ngIf="selectedFile">
    <div class="fileInfo">
      <div class="fileName">ğŸ“ {{ selectedFile.name }}</div>
      <div class="fileSize">
        {{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB
      </div>
    </div>
    <button class="removeFile" type="button" (click)="clearSelectedFile()">âœ–</button>
  </div>

  <div class="uploadErr" *ngIf="fileError">{{ fileError }}</div>

  <div class="blockedInfo" *ngIf="isBlocked">
    You blocked this user. Unblock to send messages.
  </div>

  <!-- ================= COMPOSER ================= -->
  <div class="composer" (click)="$event.stopPropagation()">
    <button
      class="attachBtn"
      [class.disabled]="sendingFile || isBlocked"
      (click)="toggleAttachMenu($event)"
      [disabled]="sendingFile || isBlocked"
      type="button"
    >
      ğŸ“
    </button>

    <!-- ATTACH MENU -->
    <div class="attachMenu" *ngIf="showAttachMenu" (click)="$event.stopPropagation()">
      <button (click)="chooseAttachType('image')">ğŸ–¼ Image</button>
      <button (click)="chooseAttachType('document')">ğŸ“„ Document</button>
    </div>

    <input #fileInput type="file" hidden (change)="pickFile($event)" />

    <input
      [(ngModel)]="text"
      placeholder="Message..."
      [disabled]="isBlocked || sendingFile"
      (keydown.enter)="send()"
      autocomplete="off"
    />

    <button
      class="sendBtn"
      (click)="send()"
      [disabled]="isBlocked || (!text.trim() && !selectedFile) || sendingFile"
    >
      {{ sendingFile ? 'Uploading...' : 'Send' }}
    </button>
  </div>

  <!-- ================= PROFILE DRAWER ================= -->
  <div
    class="drawerBackdrop"
    *ngIf="showUserProfile"
    (click)="closeProfileDrawer()"
  >
    <div class="drawer" (click)="$event.stopPropagation()">
      <button class="closeBtn" (click)="closeProfileDrawer()">âœ–</button>

      <div class="avatarLarge">{{ (user.name || 'U')[0] }}</div>

      <div class="infoSection">
        <div class="label">Name</div>
        <div class="value">{{ user.name || 'User' }}</div>
      </div>

      <div class="infoSection">
        <div class="label">Email</div>
        <div class="value">{{ user.email || 'No email' }}</div>
      </div>

      <div class="infoSection">
        <div class="label">Phone</div>
        <div class="value">{{ user.phone || 'No phone' }}</div>
      </div>

      <div class="infoSection">
        <div class="label">Joined</div>
        <div class="value">
          {{ user.createdAt | date: 'mediumDate' }}
        </div>
      </div>
    </div>
  </div>
</div>
