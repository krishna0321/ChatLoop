<div class="roomWrap" (click)="closeAllMenus()">

  <!-- âœ… HEADER -->
  <header class="header" (click)="$event.stopPropagation()">
    <div class="left">
      <div class="avatar">
        {{ (room?.name || 'G')[0] }}
      </div>

      <div class="info">
        <div class="title">{{ room?.name || 'Group' }}</div>
        <div class="sub">
          {{ room?.type || 'group' }} â€¢ {{ (room?.members?.length || 0) }} members
        </div>
      </div>
    </div>

    <button class="iconBtn" (click)="toggleHeaderMenu($event)">â‹®</button>

    <div class="dropdown" *ngIf="showHeaderMenu" (click)="$event.stopPropagation()">
      <button (click)="toggleMute()">
        {{ isMuted ? 'ğŸ”” Unmute' : 'ğŸ”• Mute' }}
      </button>
      <button (click)="togglePin()">
        {{ isPinned ? 'ğŸ“Œ Unpin' : 'ğŸ“Œ Pin' }}
      </button>
      <button class="danger" (click)="leaveGroup()">
        ğŸšª Leave Group
      </button>
      <button class="danger2" *ngIf="isOwner" (click)="deleteGroupForever()">
        âŒ Delete Group Forever
      </button>
    </div>
  </header>

  <!-- âœ… MESSAGES -->
  <div class="messages" #messagesBox>
    <div *ngIf="messages.length === 0" class="emptyMsgs">
      No messages yet...
    </div>

    <div
      *ngFor="let m of messages"
      class="bubble"
      [class.me]="m.senderId === myUid"
      (click)="openMsgMenu($event, m)"
    >
      <!-- sender -->
      <div class="sender" *ngIf="m.senderId !== myUid">
        {{ getSenderName(m.senderId) }}
      </div>

      <div class="text">

        <!-- âœ… IMAGE -->
        <ng-container *ngIf="m.type === 'image' && m.fileUrl && !m.isDeleted">
          <img class="imgMsg" [src]="m.fileUrl" />
          <div class="caption" *ngIf="m.text">{{ m.text }}</div>
        </ng-container>

        <!-- âœ… FILE -->
        <ng-container *ngIf="m.type === 'file' && m.fileUrl && !m.isDeleted">
          <a class="fileMsg" [href]="m.fileUrl" target="_blank" rel="noopener">
            <div class="fileIcon2">ğŸ“</div>
            <div class="fileMeta">
              <div class="fileName2">{{ m.fileName || 'File' }}</div>
              <div class="fileSize2">
                {{
                  (m.fileSize || 0) > 0
                    ? ((m.fileSize || 0) / 1024 / 1024).toFixed(1) + ' MB'
                    : ''
                }}
              </div>
            </div>
          </a>
        </ng-container>

        <!-- âœ… TEXT -->
        <ng-container *ngIf="(!m.type || m.type === 'text' || m.type === 'link') && !m.isDeleted">
          {{ m.text }}
        </ng-container>

        <!-- âœ… DELETED -->
        <ng-container *ngIf="m.isDeleted">
          <span class="deletedText">This message was deleted</span>
        </ng-container>

      </div>

      <div class="meta">
        {{ formatTime(m.createdAt) }}
      </div>
    </div>
  </div>

  <!-- âœ… MESSAGE MENU -->
  <div
    class="msgMenu"
    *ngIf="menuMessageId"
    [style.left.px]="menuX"
    [style.top.px]="menuY"
    (click)="$event.stopPropagation()"
  >
    <button (click)="clickEdit()">âœï¸ Edit</button>
    <button class="danger" (click)="clickDelete()">ğŸ—‘ Delete</button>
  </div>

  <!-- âœ… EDIT BAR -->
  <div class="editBar" *ngIf="editingId" (click)="$event.stopPropagation()">
    <div class="editTitle">Editing message</div>

    <div class="editRow">
      <input [(ngModel)]="editingText" placeholder="Edit message..." />
      <button (click)="saveEdit()">Save</button>
      <button class="ghost" (click)="cancelEdit()">Cancel</button>
    </div>
  </div>

  <!-- âœ… COMPOSER -->
  <div class="composer" (click)="$event.stopPropagation()">

    <!-- âœ… attach -->
    <button
      class="attachBtn"
      [class.disabled]="sendingFile"
      (click)="toggleAttachMenu($event)"
      type="button"
    >
      ğŸ“
    </button>

    <!-- âœ… attach menu -->
    <div class="attachMenu" *ngIf="showAttachMenu" (click)="$event.stopPropagation()">
      <button (click)="chooseAttachType('image')">ğŸ–¼ Image</button>
      <button (click)="chooseAttachType('document')">ğŸ“„ Document</button>
    </div>

    <!-- hidden file input -->
    <input #fileInput type="file" hidden (change)="pickFile($event)" />

    <input
      [(ngModel)]="text"
      placeholder="Write a message..."
      (keydown.enter)="send()"
      [disabled]="sendingFile"
    />

    <button
      (click)="send()"
      [disabled]="sendingFile || (!text.trim() && !selectedFile)"
    >
      {{ sendingFile ? 'Uploading...' : 'Send' }}
    </button>
  </div>

  <!-- âœ… preview -->
  <div class="filePreview" *ngIf="selectedFile">
    <div class="fileInfo">
      <div class="fileName">ğŸ“ {{ selectedFile.name }}</div>
      <div class="fileSize">{{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB</div>
    </div>
    <button class="removeFile" type="button" (click)="clearSelectedFile()">âœ–</button>
  </div>

  <div class="uploadErr" *ngIf="fileError">{{ fileError }}</div>

</div>
